@{
    ViewData["Title"] = "Trang học viên - Enlight English Center";
}

<div class="container py-5 text-center">
    <h2 class="fw-bold text-primary">
        <i class="fa-solid fa-user-graduate me-2"></i> Học viên ENLIGHT
    </h2>
    <p class="text-muted">Tra cứu khóa học, làm test đầu vào và xem kết quả học tập.</p>

    @if (ViewBag.TestStatus == null)
    {
        <!-- ✅ Đưa học viên đến danh sách khóa test -->
        <a asp-controller="LichKhaiGiang" asp-action="Index" class="btn btn-primary btn-lg shadow-sm">
            <i class="fa-solid fa-pen-to-square me-2"></i> Đăng ký Test đầu vào
        </a>
    }
    else if (ViewBag.TestStatus == "Chờ xác nhận")
    {
        <button class="btn btn-warning btn-lg shadow-sm" disabled>
            <i class="fa-solid fa-hourglass-half me-2"></i> Đang chờ xác nhận...
        </button>
    }
    else if (ViewBag.TestStatus == "Được phép test")
    {
        <div class="card border-success shadow-sm p-4 my-4">
            <h4 class="fw-bold text-success mb-3">
                <i class="fa-solid fa-circle-check me-2"></i> Bạn đã được duyệt làm bài Test
            </h4>
            <p>Khóa học: <b>@TempData["KhoaHoc"] ?? "Chưa xác định"</b></p>

            <a asp-controller="TestDauVao" asp-action="LamBai" class="btn btn-success btn-lg shadow-sm mt-3">
                <i class="fa-solid fa-play me-2"></i> Làm bài Test ngay
            </a>
        </div>
    }
    else if (ViewBag.TestStatus == "Hoàn thành")
    {
        <div class="card border-info shadow-sm p-4 my-4">
            <h4 class="fw-bold text-info mb-3">
                <i class="fa-solid fa-check-circle me-2"></i> Bạn đã hoàn thành bài Test
            </h4>
            <p>Điểm bài test: <b>@ViewBag.DiemSo</b></p>
            <p>Lớp đề xuất: <b class="text-primary">@ViewBag.LopDeXuat</b></p>

            <a asp-controller="TestDauVao" asp-action="KetQua" class="btn btn-secondary btn-lg shadow-sm mt-3">
                <i class="fa-solid fa-chart-line me-2"></i> Xem kết quả Test
            </a>
        </div>
    }
</div>
<hr class="my-5" />

<h3 class="fw-bold text-primary mb-3">
    <i class="fa-solid fa-book-open me-2"></i> Khóa học và lớp học của bạn
</h3>

@if (ViewBag.DonHocPhi == null || !((IEnumerable<dynamic>)ViewBag.DonHocPhi).Any())
{
    <div class="alert alert-warning text-center shadow-sm">
        <i class="fa-solid fa-info-circle me-2"></i> Bạn chưa đăng ký lớp học nào.
    </div>
}
else
{
    <table class="table table-bordered table-striped align-middle text-center shadow-sm">
        <thead class="table-info">
            <tr>
                <th>Ngày đăng ký</th>
                <th>Khóa học</th>
                <th>Lớp học</th>
                <th>Học phí</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var don in ViewBag.DonHocPhi)
            {
                <tr>
                    <td>@(don.NgayTao?.ToString("dd/MM/yyyy"))</td>
                    <td>@don.LopHoc?.MaKhoaHocNavigation?.TenKhoaHoc</td>
                    <td>@don.LopHoc?.TenLop</td>
                    <td>@string.Format("{0:N0} đ", don.TongTien)</td>
                    <td>
                        <span class="badge @(don.TrangThai == "Đã thanh toán" ? "bg-success" : "bg-warning text-dark")">
                            @don.TrangThai
                        </span>
                    </td>
                    <td>
                        @if (don.TrangThai == "Chờ thanh toán")
                        {
                            <form asp-controller="ThanhToan" asp-action="XacNhanThanhToan" method="post">
                                <input type="hidden" name="maDon" value="@don.MaDon" />
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="fa-solid fa-credit-card me-1"></i> Thanh toán
                                </button>
                            </form>
                        }
                        else
                        {
                            <a asp-controller="LopHoc" asp-action="ChiTiet" asp-route-id="@don.MaLop"
                               class="btn btn-outline-primary btn-sm">
                                <i class="fa-solid fa-eye me-1"></i> Xem lớp
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
@if (ViewBag.DuocHoc == true)
{
    <div class="alert alert-success mt-4 shadow-sm">
        🎓 Bạn đã được xác nhận thanh toán!
        Hãy vào xem lịch học của bạn bên dưới:
    </div>

    <a asp-controller="LopHoc" asp-action="ChiTiet" class="btn btn-success mt-2">
        <i class="fa-solid fa-calendar-days me-2"></i> Xem lịch học
    </a>
}
else
{
    <div class="alert alert-warning mt-4 shadow-sm">
        ⏳ Bạn chưa được xác nhận thanh toán.
        Vui lòng liên hệ lễ tân để hoàn tất thủ tục học phí.
    </div>
}
