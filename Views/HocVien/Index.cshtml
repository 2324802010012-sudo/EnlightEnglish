@{
    ViewData["Title"] = "Trang học viên - Enlight English Center";
}

<div class="container py-5 text-center">
    <h2 class="fw-bold text-primary mb-3">
        <i class="fa-solid fa-user-graduate me-2"></i> Học viên ENLIGHT
    </h2>
    <p class="text-muted mb-4">
        Tra cứu khóa học, làm Test đầu vào và xem kết quả học tập 📚
    </p>

    @* ================== PHẦN TEST ĐẦU VÀO ================== *@
    @{
        string status = ViewBag.TestStatus as string ?? "";
        string diemSo = ViewBag.DiemSo as string ?? "";
    }

    @if (string.IsNullOrEmpty(status))
    {
        <!-- 🟦 Học viên mới chưa có bài test -->
        <a asp-controller="TestDauVao" asp-action="Index" class="btn btn-primary btn-lg rounded-pill shadow-sm">
            <i class="fa-solid fa-pen-to-square me-2"></i> Đăng ký Test đầu vào
        </a>
    }
    else if (status == "Chờ xác nhận")
    {
        <button class="btn btn-warning btn-lg rounded-pill shadow-sm" disabled>
            <i class="fa-solid fa-hourglass-half me-2"></i> Đang chờ xác nhận...
        </button>
    }
    else if (status == "Được phép test")
    {
        <div class="card border-success shadow-sm p-4 mt-4">
            <h4 class="fw-bold text-success mb-2">
                <i class="fa-solid fa-circle-check me-2"></i> Bạn đã được duyệt làm bài Test
            </h4>
            <p>Khóa học: <b>@TempData["KhoaHoc"] ?? "Chưa xác định"</b></p>
            <a asp-controller="TestDauVao" asp-action="LamBai" class="btn btn-success btn-lg rounded-pill mt-3 shadow-sm">
                <i class="fa-solid fa-play me-2"></i> Làm bài Test ngay
            </a>
        </div>
    }
    else if (status == "Hoàn thành" && !string.IsNullOrEmpty(diemSo) && diemSo != "0.0")
    {
        <div class="card border-info shadow-sm p-4 mt-4">
            <h4 class="fw-bold text-info mb-2">
                <i class="fa-solid fa-check-circle me-2"></i> Bạn đã hoàn thành bài Test
            </h4>
            <p>Điểm bài test: <b>@ViewBag.DiemSo</b></p>
            <p>Lớp đề xuất: <b class="text-primary">@ViewBag.LopDeXuat</b></p>
            <a asp-controller="TestDauVao" asp-action="KetQua" class="btn btn-outline-info rounded-pill mt-3 shadow-sm">
                <i class="fa-solid fa-chart-line me-2"></i> Xem kết quả Test
            </a>
        </div>
    }
    else
    {
        <!-- 🧹 Nếu trạng thái lạ hoặc điểm = 0 thì xem như chưa test -->
        <a asp-controller="LichKhaiGiang" asp-action="Index" class="btn btn-primary btn-lg rounded-pill shadow-sm">
            <i class="fa-solid fa-pen-to-square me-2"></i> Đăng ký Test đầu vào
        </a>

    }
</div>

<hr class="my-5" />

@* ================== PHẦN KHÓA HỌC & LỚP HỌC ================== *@
<div class="container py-4">
    <h3 class="fw-bold text-primary text-center mb-4">
        <i class="fa-solid fa-book-open me-2"></i> Khóa học và lớp học của bạn
    </h3>

    @if (ViewBag.DonHocPhi == null || !((IEnumerable<dynamic>)ViewBag.DonHocPhi).Any())
    {
        <div class="alert alert-warning text-center shadow-sm">
            <i class="fa-solid fa-info-circle me-2"></i> Bạn chưa đăng ký lớp học nào.
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            @foreach (var don in ViewBag.DonHocPhi)
            {
                string badgeClass = don.TrangThai == "Đã thanh toán"
                ? "bg-success"
                : "bg-warning text-dark";

                <div class="col-md-5 col-lg-4 mb-4">
                    <div class="card shadow-sm border-0 rounded-4 h-100">
                        <div class="card-body p-4 text-center">
                            <h5 class="fw-bold text-primary mb-2">
                                <i class="fa-solid fa-book me-2"></i>
                                @don.LopHoc?.MaKhoaHocNavigation?.TenKhoaHoc
                            </h5>

                            <p class="mb-1"><b>Lớp:</b> @don.LopHoc?.TenLop</p>
                            <p class="mb-1"><b>Ngày đăng ký:</b> @don.NgayTao?.ToString("dd/MM/yyyy")</p>
                            <p class="mb-1"><b>Học phí:</b> @string.Format("{0:N0} đ", don.TongTien)</p>
                            <p class="mb-2">
                                <b>Trạng thái:</b>
                                <span class="badge @badgeClass">@don.TrangThai</span>
                            </p>

                            @if (don.TrangThai == "Chờ thanh toán")
                            {
                                <form asp-controller="ThanhToan" asp-action="XacNhanThanhToan" method="post">
                                    <input type="hidden" name="maDon" value="@don.MaDon" />
                                    <button type="submit" class="btn btn-success rounded-pill px-4 mt-2">
                                        <i class="fa-solid fa-credit-card me-1"></i> Thanh toán
                                    </button>
                                </form>
                            }
                            else
                            {
                                @if (don.TrangThai == "Đã thanh toán" || don.TrangThai == "Đã xác nhận lễ tân")
                                {
                                    <!-- ✅ Chỉ khi lễ tân xác nhận mới cho xem lớp -->
                                    <a asp-controller="LopHoc" asp-action="ChiTiet" asp-route-id="@don.MaLop"
                                       class="btn btn-outline-primary rounded-pill px-4 mt-2">
                                        <i class="fa-solid fa-eye me-1"></i> Xem lớp
                                    </a>
                                }
                                else
                                {
                                    <!-- 🚫 Chưa được xác nhận thì khóa nút lại -->
                                    <button class="btn btn-secondary rounded-pill px-4 mt-2" disabled>
                                        <i class="fa-solid fa-lock me-1"></i> Chờ xác nhận lễ tân
                                    </button>
                                }

                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

@{
    // ✅ Kiểm tra có đơn nào đã thanh toán hoặc đã được xác nhận lễ tân chưa
    bool daThanhToan = false;

    if (ViewBag.DonHocPhi != null)
    {
        var donList = (IEnumerable<dynamic>)ViewBag.DonHocPhi;
        daThanhToan = donList.Any(d =>
        d.TrangThai == "Đã thanh toán" ||
        d.TrangThai == "Đã xác nhận lễ tân");
    }
}

@if (daThanhToan || ViewBag.DuocHoc == true)
{
        <!-- ✅ Khi học viên đã được xác nhận thanh toán -->
        <div class="alert alert-success mt-4 shadow-sm text-center">
            🎓 Bạn đã được xác nhận thanh toán! Hãy vào xem lịch học của bạn bên dưới:
        </div>
      
}
else
{
        <!-- 🚫 Chưa được xác nhận -->
        <div class="alert alert-warning mt-4 shadow-sm text-center">
            ⏳ Bạn chưa được xác nhận thanh toán.
            Vui lòng liên hệ lễ tân để hoàn tất thủ tục học phí.
        </div>
}

